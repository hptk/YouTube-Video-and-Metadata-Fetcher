<div ng-include src="'static/app/shared/topnavigation/navigationView.html'"></div>
<div class="container">
<div class="row">
<div class="panel panel-default">
		  <div style="width:100%;" class="panel-heading btn" uib-dropdown>
		    
		    
		      <h3 class="panel-title" uib-dropdown-toggle ng-disabled="disabled">
		        {{vm.maxOldQueries.selectedOption.value}} recent queries <span class="caret"></span>
		      </h3>
		      
		      <ul class="uib-dropdown-menu" role="menu" style="width:100%;">
		      
		      	<li ng-repeat="option in vm.maxOldQueries.availableOptions">
		      		<a ng-click="vm.maxOldQueries.selectedOption.value=option.value;vm.loadOldQueries()">{{option.value}} recent queries</a>
		      	</li>

		      </ul> 
		  </div>
		  <div style="padding:0px;" class="panel-body">
		    <ui-select ng-model="vm.selectedOldQuery" on-select="vm.changeToResult($select.selected.id)">
			            <ui-select-match placeholder="Select a recent query">
			            {{$select.selected.id}}
			            </ui-select-match>
			            <ui-select-choices repeat="query as query in vm.oldQueries  | filter: $select.search">
			            <div class="row">
			            	<div class="col-xs-12 col-sm-6">
			              <div ng-bind-html="query.id | highlight: $select.search"></div>
			              <div ng-repeat="(key, value) in query.queryRaw" class="clearfix">
			              	<small class="pull-left">{{key}}:</small>
			              	<small class="pull-right" ng-bind-html="value | highlight: $select.search"></small>
			             </div>
			             </div>
			             <div class="col-xs-12 col-sm-6">
			             <span>Performed Tasks</span>
			             <div ng-repeat="task in query.tasks track by task.id" class="clearfix">
			             	
			             	<div class="clearfix">
			             	<div class="pull-left"  ng-bind-html="task.action | highlight: $select.search"></div>
			             	<small class="pull-right" ng-bind-html="task.created_on"></small>
			             	
			             	</div>
			             	<div class="clearfix">
			              		<small class="pull-left">Result</small>
			              		<small class="pull-right" ng-bind-html="task.result.result"></small>
			              	</div>
			             </div>
			            </div>
			            </div>
			            </ui-select-choices>
			            
			          </ui-select>
		</div>
		  </div>

</div>
<div class="row">
<a class="btn btn-primary" href="/api/statistics/{{$routeParams.id}}">Download statistic data</a>
{{vm.result}}
<div class="col-xs-12">
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">publishedAt</h3>
  </div>
  <div class="panel-body">
    <div ng-if="plot.publishedAt.length" ui-chart="plot.publishedAt" chart-options="publishedAtChartOptions"></div>
  </div>
</div>
</div>
</div>
<div class="row">
<div class="col-xs-12">
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Associated Queries</h3>
  </div>
  <div class="panel-body">
  <div class="form-group">
      <div class="input-group">
        <div class="input-group-addon"><i class="fa fa-search"></i></div>
        <input type="text" class="form-control" placeholder="Search Query" ng-model="searchKey">
      </div>      
    </div>
    <table class="table table-bordered table-striped">
    
    <thead>
      <tr>
        <td>
          <a  ng-click="sortType = 'id'; sortReverse = !sortReverse">
            ID
            <span ng-show="sortType == 'id' && !sortReverse" class="fa fa-caret-down"></span>
            <span ng-show="sortType == 'id' && sortReverse" class="fa fa-caret-up"></span>
          </a>
        </td>
        <td>
          <a  ng-click="sortType = 'parameter'; sortReverse = !sortReverse">
          Parameters
            <span ng-show="sortType == 'parameter' && !sortReverse" class="fa fa-caret-down"></span>
            <span ng-show="sortType == 'parameter' && sortReverse" class="fa fa-caret-up"></span>
          </a>
        </td>
        <td>
          <a ng-click="sortType = 'intersection'; sortReverse = !sortReverse">
          Intersection <i class="glyphicon glyphicon-info-sign" uib-popover="How many of the current query's videos are also fetched by other queries" popover-trigger="mouseenter"></i>
            <span ng-show="sortType == 'intersection' && !sortReverse" class="fa fa-caret-down"></span>
            <span ng-show="sortType == 'intersection' && sortReverse" class="fa fa-caret-up"></span>
          </a>
        </td>
        
        <td>
        Action
        </td>
      </tr>
    </thead>
    
    <tbody>
      <tr  ng-repeat="assoc in vm.result.intersection | orderBy:sortType:sortReverse | filter:searchKey">
        <td >{{ assoc.query.id }}</td>
        <td>
        	<ul>
				<li ng-repeat="(key, value) in assoc.query.queryRaw " >
					<b class="pull-left">{{ key }}:</b> <span class="pull-right">{{ value }}</span>
				</li>
			</ul>
        </td>
        <td>
        	<span class="pull-right">{{assoc.count}} / {{vm.result.data.videos}}</span>
        	<uib-progressbar style="display:block;width:100%;" max="vm.result.data.videos" value="assoc.count"><span style="color:white; white-space:nowrap;">{{((assoc.count/vm.result.data.videos)*100|number:0)}} %</span></uib-progressbar>
        	
        </td>
  		
        <td>
        	<a class="btn btn-primary" href="#/result/{{ assoc.query.id }}">Load result for {{ assoc.query.id }}</a><br>
        	<a class="btn btn-primary" href="#/query/{{ assoc.query.id }}">Open Query Builder for {{ assoc.query.id }}</a>
        </td>
      </tr>
    </tbody>
    
  </table>
  </div>
</div>
</div>
</div>


<div class="col-xs-12 col-sm-6">
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Categories</h3>
  </div>
  <div class="panel-body">
    <div ng-if="plot.categories.length" ui-chart="plot.categories" chart-options="categoriesChartOptions"></div>
  </div>
</div>
</div>
<div class="col-xs-12">           

</div>


</div>
</div>